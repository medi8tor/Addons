local G,U=...local h=HeroCache local w=U.Unit local i=w.Player local Z=w.Pet local M=w.Target local d=U.Spell local O=U.MultiSpell local c=U.Item local C=pairs local H=ipairs local W=table.insert local k=GetTime local Y={}local n={}local g={}local o={}local b={}local y={Whitelist={},Blacklist={}}do local G U:RegisterForSelfCombatEvent(function(U,h,w,i,Z,M,d,O,c,C,H,W)for U=1,#Y,1 do G=n[Y[U]][W]if G then G.LastCastTime=k()G.LastHitTime=k()+G:TravelTime()end end G=g[W]if G then G.LastCastTime=k()end G=o[W]if G then G.LastCastTime=k()end end,"\083\080\069\076\076\095\067\065\083\084\095\083\085\067\067\069\083\083")end do local G U:RegisterForPetCombatEvent(function(U,h,w,i,Z,M,d,O,c,C,H,W)for U=1,#Y,1 do G=n[Y[U]][W]if G then G.LastCastTime=k()G.LastHitTime=k()+G:TravelTime()end end end,"\083\080\069\076\076\095\067\065\083\084\095\083\085\067\067\069\083\083")end do local G U:RegisterForSelfCombatEvent(function(U,h,w,i,Z,M,d,O,c,C,H,W)for U=1,#Y,1 do G=n[Y[U]][W]if G then G.LastAppliedOnPlayerTime=k()end end end,"\083\080\069\076\076\095\065\085\082\065\095\065\080\080\076\073\069\068")end do local G U:RegisterForSelfCombatEvent(function(U,h,w,i,Z,M,d,O,c,C,H,W)for U=1,#Y,1 do G=n[Y[U]][W]if G then G.LastRemovedFromPlayerTime=k()end end end,"\083\080\069\076\076\095\065\085\082\065\095\082\069\077\079\086\069\068")end function i.RegisterListenedItemSpells(G)g={}local U=G:GetOnUseItems()for G,U in H(U)do local h=U:OnUseSpell()if h then g[h:ID()]=h end end end function i.RegisterListenedSpells(h,G)Y={}n={}o={}local w=U.SpecID_ClassesSpecs[G][1]for G,U in C(U.Spell[w])do W(Y,G)n[G]={}for U,h in C(U)do if h:ID()then n[G][h:ID()]=h end end end for G,U in C(y.Whitelist)do for h=1,#Y,1 do n[Y[h]][G]=U end end for G=1,#y.Blacklist,1 do local U=y.Blacklist[G]for G=1,#Y,1 do local h=Y[G]if n[h][U]then n[h][U]=nil end end end if U.Item[w]then for G,U in C(U.Item[w])do for G,U in C(U)do local h=U:OnUseSpell()if h then o[h:ID()]=h end end end end end function d.AddToListenedSpells(G)y.Whitelist[G.SpellID]=G end function d.RemoveFromListenedSpells(G)W(y.Blacklist,G.SpellID)end function O.AddToMultiSpells(G)W(b,G)end U:RegisterForEvent(function(G,U)for G,U in C(b)do U:Update()end end,"\080\076\065\089\069\082\095\076\079\071\073\078","\083\080\069\076\076\083\095\067\072\065\078\071\069\068")