local G,U=...local h=HeroDBC.DBC local w=HeroCache local i=U.Unit local Z=i.Player local M=i.Pet local d=i.Target local O=U.Spell local c=U.Item local C=pairs local H=table.insert local W=math.max local k=GetTime local Y=h.SpellGCD local n=15 local g=0 local o=0 local b=0 local y={GCD={},OffGCD={},PetGCD={};PetOffGCD={}}local T={Whitelist={},Blacklist={}}local m={Spell=nil;Time=0}local K=O(61304)for G=1,n,1 do for G,U in C(y)do H(U,0)end end local function t()for G,U in C(y)do local h=#U while h>n do U[h]=nil h=h-1 end end end U:RegisterForSelfCombatEvent(function(G,h,w,i,Z,M,d,O,c,C,W,n)U.Timer.LastCastSuccess=k()if Y[n]~=nil then if Y[n]then H(y.GCD,1,n)o=k()y.OffGCD={}b=0 g=0 else H(y.OffGCD,1,n)b=k()o=0 end end t()end,"\083\080\069\076\076\095\067\065\083\084\095\083\085\067\067\069\083\083")U:RegisterForSelfCombatEvent(function(G,U,h,w,i,Z,M,d,O,c,C,H)if Y[H]then g=H end end,"\083\080\069\076\076\095\067\065\083\084\095\083\084\065\082\084")U:RegisterForSelfCombatEvent(function(G,U,h,w,i,Z,M,d,O,c,C,H)if g==H then g=0 end end,"\083\080\069\076\076\095\067\065\083\084\095\070\065\073\076\069\068")U:RegisterForPetCombatEvent(function(G,U,h,w,i,Z,M,d,O,c,C,W)if Y[W]~=nil then if Y[W]then H(y.PetGCD,1,W)y.PetOffGCD={}else H(y.PetOffGCD,1,W)end end t()end,"\083\080\069\076\076\095\067\065\083\084\095\083\085\067\067\069\083\083")function Z.FilterTriggerGCD(w,G)local i={}local Z=h.SpellGCD for G,U in C(U.Spell[U.SpecID_ClassesSpecs[G][1]])do for G,U in C(U)do local h=U:ID()local w=Z[h]if w~=nil then i[h]=w>0 end end end for G,U in C(T.Whitelist)do i[G]=U end for G=1,#T.Blacklist,1 do local U=T.Blacklist[G]if i[U]then i[U]=nil end end Y=i end function O.AddToTriggerGCD(U,G)if type(G)~="\098\111\111\108\101\097\110"then error("\089\111\117 \109\117\115\116 \103\105\118\101 \097 \098\111\111\108\101\097\110 \097\115 \097\114\103\117\109\101\110\116\046")end T.Whitelist[U.SpellID]=G end function O.RemoveFromTriggerGCD(G)H(T.Blacklist,G.SpellID)end function Z.PrevGCDTime(G)return o end function Z.PrevOffGCDTime(G)return b end function Z.PrevCastTime(G)return W(o,b)end function Z.IsPrevCastPending(G)if g>0 then return false end local U,h=K:CooldownInfo()if h>0 and U>o then return true end return false end function Z.SetPrevSuggestedSpell(U,G)if G==nil or G.SpellID~=nil then local U,h=K:CooldownInfo()if h>0 and U>o then return end m.Spell=G m.Time=k()end end function Z.PrevGCD(h,G,U)if G>n then error("\079\110\108\121 \116\104\101 \108\097\115\116 "..(n.." \071\067\068\115 \099\097\110 \098\101 \099\104\101\099\107\101\100\046"))end if U then return y.GCD[G]==U:ID()else return y.GCD[G]end end function Z.PrevGCDP(w,G,U,h)if G>n then error("\079\110\108\121 \116\104\101 \108\097\115\116 "..(n.." \071\067\068\115 \099\097\110 \098\101 \099\104\101\099\107\101\100\046"))end local i=g if i==0 and(m.Spell and m.Time>o)then local G=m.Spell:ID()local U,h=K:CooldownInfo()if h>0 and(U>o and Y[G])then i=G end end if i>0 and G==1 or h then return i==U:ID()elseif i>0 then return Z:PrevGCD(G-1,U)else return Z:PrevGCD(G,U)end end function Z.PrevOffGCD(h,G,U)if G>n then error("\079\110\108\121 \116\104\101 \108\097\115\116 "..(n.." \079\102\102\071\067\068\115 \099\097\110 \098\101 \099\104\101\099\107\101\100\046"))end return y.OffGCD[G]==U:ID()end function Z.PrevOffGCDP(h,G,U)if G>n then error("\079\110\108\121 \116\104\101 \108\097\115\116 "..(n.." \071\067\068\115 \099\097\110 \098\101 \099\104\101\099\107\101\100\046"))end if g>0 and G==1 then return false elseif g>0 then return Z:PrevOffGCD(G-1,U)else return Z:PrevOffGCD(G,U)end end function M.PrevGCD(h,G,U)if G>n then error("\079\110\108\121 \116\104\101 \108\097\115\116 "..(n.." \071\067\068\115 \099\097\110 \098\101 \099\104\101\099\107\101\100\046"))end return y.PetGCD[G]==U:ID()end function M.PrevOffGCD(h,G,U)if G>n then error("\079\110\108\121 \116\104\101 \108\097\115\116 "..(n.." \079\102\102\071\067\068\115 \099\097\110 \098\101 \099\104\101\099\107\101\100\046"))end return y.PetOffGCD[G]==U:ID()end