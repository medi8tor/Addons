local l,t=...local D=HeroDBC.DBC local B,G=HeroCache,t.Utils local k=t.Unit local o,d,e=k.Player,k.Pet,k.Target local I,R=k.Focus,k.MouseOver local N,L,V=k.Arena,k.Boss,k.Nameplate local K,E=k.Party,k.Raid local x=t.Spell local P=t.Item local q=C_Item.IsItemInRange local y=C_Item.IsUsableItem local p=C_Spell.IsSpellInRange local g=InCombatLockdown local Y=IsActionInRange local w=math.max local M=math.random local T=pairs local s=table.sort local z=type local A=unpack local h={Melee={Hostile={RangeIndex={};ItemRange={}};Friendly={RangeIndex={};ItemRange={}}};Ranged={Hostile={RangeIndex={};ItemRange={}},Friendly={RangeIndex={},ItemRange={}}}}do local l={"\077\101\108\101\101";"\082\097\110\103\101\100"}for l,t in T(l)do local B=D.ItemRange[t]local k,o=h[t].Hostile,h[t].Friendly k.RangeIndex={A(B.Hostile.RangeIndex)}s(k.RangeIndex,G.SortMixedASC)o.RangeIndex={A(B.Friendly.RangeIndex)}s(o.RangeIndex,G.SortMixedASC)for l,t in T(B.Hostile.ItemRange)do k.ItemRange[l]=t[M(1,#t)]end for l,t in T(B.Friendly.ItemRange)do o.ItemRange[l]=t[M(1,#t)]end end end function t.CheckRangeTable(l)local B={"\077\101\108\101\101";"\082\097\110\103\101\100"}local G=0 for l,B in T(B)do local k=D.ItemRange[B]local o={"\072\111\115\116\105\108\101","\070\114\105\101\110\100\108\121"}for l,D in T(o)do for l,o in T(k[D].RangeIndex)do local d=0 for l,D in T(k[D].ItemRange[o])do local k=0 local e=(t.Item(D)):OnUseSpell()if B=="\082\097\110\103\101\100"then k=e and((t.Item(D)):OnUseSpell()).MaximumRange or 0 end if B=="\082\097\110\103\101\100"and k~=o or not e then t.Print("---------")t.Print("\084\097\098\108\101 \084\121\112\101\058 "..tostring(B))t.Print("\082\097\110\103\101 \066\101\105\110\103 \067\104\101\099\107\101\100\058 "..tostring(o))t.Print("\073\116\101\109 \119\105\116\104 \066\097\100 \082\097\110\103\101\058 "..tostring(D))t.Print("\065\099\116\117\097\108 \073\116\101\109 \082\097\110\103\101\058 "..tostring(k))d=d+1 G=G+1 end end if d>0 then t.Print("----------------")t.Print("\084\097\098\108\101 \084\121\112\101\058 "..tostring(B))t.Print("\084\111\116\097\108 \073\116\101\109\115 \105\110 \082\097\110\103\101 "..(tostring(o)..("\058 "..tostring(#k[D].ItemRange[o]))))t.Print("\084\111\116\097\108 \070\097\105\108\117\114\101\115\058 "..tostring(d))end end end end t.Print("----------------")t.Print("\079\118\101\114\097\108\108 \070\097\105\108\117\114\101\115\058 "..tostring(G))end function k.IsInRange(t,l)assert(z(l)=="\110\117\109\098\101\114","\068\105\115\116\097\110\099\101 \109\117\115\116 \098\101 \097 \110\117\109\098\101\114\046")assert(l>=5 and l<=100,"\068\105\115\116\097\110\099\101 \109\117\115\116 \098\101 \098\101\116\119\101\101\110 \053 \097\110\100 \049\048\048\046")local D=t:GUID()if not D then return false end local G=B.UnitInfo[D]if not G then G={}B.UnitInfo[D]=G end local k=G.IsInRange if not k then k={}G.IsInRange=k end local d=l local e=k[d]if e==nil then if g()and(t:IsAPlayer()or not o:CanAttack(t))then return true end local D=h.Ranged local B=o:CanAttack(t)and D.Hostile or D.Friendly local G=B.ItemRange if not G[l]then local t=B.RangeIndex for D=#t,1,-1 do local B=t[D]if B==l then break end if B<l then l=B break end end end e=q(G[l],t:ID())k[d]=e end return e end function k.IsInMeleeRange(t,l)assert(z(l)=="\110\117\109\098\101\114","\068\105\115\116\097\110\099\101 \109\117\115\116 \098\101 \097 \110\117\109\098\101\114\046")assert(l>=5 and l<=100,"\068\105\115\116\097\110\099\101 \109\117\115\116 \098\101 \098\101\116\119\101\101\110 \053 \097\110\100 \049\048\048\046")l=w(l-1.5,5)if l~=5 then return t:IsInRange(l)end local D=t:GUID()if not D then return false end if g()and(t:IsAPlayer()or not o:CanAttack(t))then return true end local B=h.Melee local G=o:CanAttack(t)and B.Hostile or B.Friendly local k=G.ItemRange return q(k[l],t:ID())end function k.IsSpellInRange(t,l)local D=t:GUID()if not D then return false end return p(l:ID(),t:ID())end function k.IsItemInRange(t,l)local D=t:GUID()if not D then return false end if g()and(t:IsAPlayer()or not o:CanAttack(t))then return false end return q(l:ID(),t:ID())end function k.IsActionInRange(t,l)return Y(l,t:ID())end local function u(l,t)if g()and(l:IsAPlayer()or not o:CanAttack(l))then return 0 end local D=h.Ranged local B=o:CanAttack(l)and D.Hostile or D.Friendly local G=B.RangeIndex for D=#G-(t and 1 or 0),1,-1 do if not l:IsInRange(G[D])then return t and G[D+1]or G[D]end end end function k.MinDistance(l)return u(l)end function k.MaxDistance(l)return u(l,true)end